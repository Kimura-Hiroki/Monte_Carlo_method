<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>モンテカルロ法（円周率の推定）</title>
  <style>
    :root{
      --bg:#f7faff; --panel:#ffffff; --ink:#1f2a44; --muted:#6b7a99; --line:#e6eef8;
      --brand:#2f80ed; --ok:#16a34a; --ng:#e11d48; --pi:#b45309; --pi-bg:#fff7e6;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; color:var(--ink); background:var(--bg)}
    .wrap{max-width:1100px; margin:0 auto; padding:20px}
    header{display:flex; align-items:baseline; gap:10px; flex-wrap:wrap}
    h1{font-size:clamp(20px,4vw,28px); margin:0; color:var(--brand)}
    .sub{color:var(--muted)}

    .layout{display:grid; grid-template-columns: minmax(0,1fr) 360px; gap:16px; margin-top:16px}
    @media (max-width: 960px){ .layout{grid-template-columns:1fr} }

    .card{background:var(--panel); border:1px solid var(--line); border-radius:14px; box-shadow:0 6px 16px rgba(31,42,68,0.06)}
    .card .hd{padding:12px 14px; border-bottom:1px solid var(--line); font-weight:600; color:var(--muted)}
    .card .bd{padding:14px}

    canvas{width:100%; height:auto; display:block; background:#fff; border-bottom-left-radius:14px; border-bottom-right-radius:14px}

    .legend{display:flex; gap:12px; align-items:center; color:var(--muted); font-size:13px}
    .dot{width:10px; height:10px; border-radius:50%; display:inline-block}

    .controls{display:grid; grid-template-columns: 1fr 1fr; gap:8px}
    button{padding:10px 12px; border-radius:10px; border:1px solid var(--line); cursor:pointer; background:#f4f8ff; font:inherit}
    button:hover{filter:brightness(0.98)}
    .primary{background:linear-gradient(#2f80ed,#2267c9); color:#fff; border-color:#1c57ab}
    .danger{background:#fde7eb; border-color:#f6b6c4; color:#b11e3a}
    .full{grid-column:1 / -1}

    .row{display:flex; align-items:center; gap:10px}
    .mini{font-size:12px; color:var(--muted)}

    .kpi{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:8px}
    .kpi .item{border:1px solid var(--line); border-radius:10px; padding:10px}
    .kpi .lbl{font-size:12px; color:var(--muted)}
    .kpi .val{font-variant-numeric:tabular-nums; font-size:20px}

    .bar{height:10px; background:#eef5ff; border-radius:999px; border:1px solid var(--line); overflow:hidden}
    .bar > span{display:block; height:100%; width:0%; background:linear-gradient(90deg, #16a34a, #2f80ed)}

    /* 図と配色が連動する数式（段組改行版） */
    .formula{background:#f7fbff; border:1px dashed #cfe3ff; border-radius:10px; padding:12px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; white-space:pre-line}
    .chip{display:inline-block; padding:2px 6px; border-radius:999px; font-size:12px; border:1px solid var(--line)}
    .chip.in{background:#e9f8ef; color:var(--ok)}
    .chip.n{background:#eef5ff; color:var(--brand)}
    .val{padding:2px 6px; border-radius:6px; font-variant-numeric:tabular-nums}
    .val.in{background:#e9f8ef; color:var(--ok)}
    .val.n{background:#eef5ff; color:var(--brand)}
    .val.pi{background:var(--pi-bg); color:var(--pi)}

    .help{color:var(--muted); font-size:13px; margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>モンテカルロ法による円周率の推定</h1>
      <div class="sub">ランダムに点を打って、<code>π ≈ 4 × (円の中の点 / 全部の点)</code> を体感しよう</div>
    </header>

    <div class="layout">
      <!-- 左：グラフ表示 -->
      <section class="card" aria-labelledby="vizTitle">
        <div class="hd" id="vizTitle">グラフ表示</div>
        <div class="bd" style="padding-bottom:0">
          <div class="legend" aria-hidden="true" style="margin-bottom:8px">
            <span class="dot" style="background:var(--ok)"></span> 円の中（in）
            <span class="dot" style="background:var(--ng)"></span> 円の外
          </div>
          <canvas id="plot" width="560" height="560" aria-label="モンテカルロ可視化キャンバス"></canvas>
        </div>
      </section>

      <!-- 右：操作と結果 -->
      <aside class="card" aria-labelledby="ctlTitle">
        <div class="hd" id="ctlTitle">実験と結果</div>
        <div class="bd">
          <div class="controls">
            <button id="btnToggle" class="primary">▶ スタート</button>
            <button id="btnStep">➕ 1ステップ</button>
            <button id="btnReset" class="danger full">🗑 リセット</button>
          </div>

          <div class="row" style="margin-top:10px">
            <label class="mini" for="spd">1ステップで打つ点の数: <span id="spdVal">200</span></label>
            <input id="spd" type="range" min="10" max="3000" value="200" style="flex:1" />
          </div>

          <div class="kpi" style="margin-top:12px" aria-live="polite">
            <div class="item"><div class="lbl">全部の点 n</div><div class="val" id="statN">0</div></div>
            <div class="item"><div class="lbl">円の中 in</div><div class="val" id="statIn">0</div></div>
            <div class="item"><div class="lbl">比率 in/n</div><div class="val" id="statRatio">—</div></div>
            <div class="item"><div class="lbl">推定 π̂</div><div class="val" id="statPi">—</div></div>
          </div>

          <div class="help">緑の点（in）÷ ぜんぶの点（n）＝ in/n のバー。これを4倍すると π に近づくよ。</div>
          <div class="bar" aria-label="in/n の割合バー" title="in / n の割合"><span id="ratioBar"></span></div>

          <!-- 改行で段組した数式（図と色連動） -->
          <div class="formula" style="margin-top:12px" aria-live="polite">
π ≈
4 × <span class="chip in">in（円の中の点）</span> / <span class="chip n">n（全部の点）</span>
＝ 4 × (<span class="val in" id="fIn">0</span> / <span class="val n" id="fN">0</span>)
＝ <span class="val pi" id="fPi">—</span>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // ========= キャンバス基本設定 =========
    const canvas = document.getElementById('plot');
    const ctx = canvas.getContext('2d');
    const DPR = Math.max(1, window.devicePixelRatio || 1);

    function drawBase(){
      const m = Math.min(canvas.width, canvas.height);
      ctx.clearRect(0,0,canvas.width, canvas.height);
      // 外枠
      ctx.strokeStyle = '#cfd9ea';
      ctx.lineWidth = 2 * DPR;
      ctx.strokeRect(0.5*DPR, 0.5*DPR, m-1*DPR, m-1*DPR);
      // 円（中心(0.5,0.5), 半径0.5）
      ctx.beginPath();
      ctx.arc(m/2, m/2, m/2, 0, Math.PI*2);
      ctx.strokeStyle = '#2f80ed';
      ctx.lineWidth = 3 * DPR;
      ctx.stroke();
    }

    // ========= 状態 =========
    let running = false;
    let n = 0, inside = 0;
    let pointsPerStep = 200;
    const colorIn = getComputedStyle(document.documentElement).getPropertyValue('--ok').trim() || '#16a34a';
    const colorOut = getComputedStyle(document.documentElement).getPropertyValue('--ng').trim() || '#e11d48';

    // ========= UI要素 =========
    const btnToggle = document.getElementById('btnToggle');
    const btnStep = document.getElementById('btnStep');
    const btnReset = document.getElementById('btnReset');
    const spd = document.getElementById('spd');
    const spdVal = document.getElementById('spdVal');

    const statN = document.getElementById('statN');
    const statIn = document.getElementById('statIn');
    const statRatio = document.getElementById('statRatio');
    const statPi = document.getElementById('statPi');
    const ratioBar = document.getElementById('ratioBar');

    const fIn = document.getElementById('fIn');
    const fN  = document.getElementById('fN');
    const fPi = document.getElementById('fPi');

    function updateStats(){
      statN.textContent = n.toLocaleString();
      statIn.textContent = inside.toLocaleString();
      if(n>0){
        const ratio = inside/n;
        const pi = 4*ratio;
        statRatio.textContent = ratio.toFixed(6);
        statPi.textContent = pi.toFixed(6);
        ratioBar.style.width = Math.min(100, Math.max(0, ratio*100)).toFixed(2) + '%';
        fIn.textContent = inside.toLocaleString();
        fN.textContent  = n.toLocaleString();
        fPi.textContent = pi.toFixed(6);
      }else{
        statRatio.textContent = '—';
        statPi.textContent = '—';
        ratioBar.style.width = '0%';
        fIn.textContent = 0; fN.textContent = 0; fPi.textContent = '—';
      }
    }

    function throwPoints(k){
      const m = Math.min(canvas.width, canvas.height);
      const r = Math.max(1, Math.round(2*DPR));
      for(let i=0;i<k;i++){
        const x = Math.random();
        const y = Math.random();
        const dx = x-0.5, dy = y-0.5;
        const isIn = (dx*dx+dy*dy <= 0.25);
        const px = x*m, py = (1-y)*m; // yは上向き
        ctx.beginPath(); ctx.fillStyle = isIn ? colorIn : colorOut; ctx.arc(px, py, r, 0, Math.PI*2); ctx.fill();
        n++; if(isIn) inside++;
      }
      updateStats();
    }

    function step(){ throwPoints(pointsPerStep); }

    let rafId=null;
    function loop(){ if(!running) return; step(); rafId = requestAnimationFrame(loop); }

    // ========= イベント =========
    btnToggle.addEventListener('click', ()=>{
      running = !running;
      btnToggle.textContent = running ? '⏸ 一時停止' : '▶ スタート';
      btnToggle.classList.toggle('primary', !running);
      if(running) loop(); else if(rafId) cancelAnimationFrame(rafId);
    });

    btnStep.addEventListener('click', ()=>{ running=false; btnToggle.textContent='▶ スタート'; if(rafId) cancelAnimationFrame(rafId); step(); });

    btnReset.addEventListener('click', ()=>{
      running=false; if(rafId) cancelAnimationFrame(rafId);
      n=0; inside=0; updateStats(); drawBase(); btnToggle.textContent='▶ スタート';
    });

    spd.addEventListener('input', (e)=>{ pointsPerStep = parseInt(e.target.value,10)||10; document.getElementById('spdVal').textContent = pointsPerStep; });

    // ショートカット: Spaceで開始/停止、Sで1ステップ、Rでリセット
    window.addEventListener('keydown', (e)=>{
      if(e.code==='Space'){ e.preventDefault(); btnToggle.click(); }
      if(e.key==='s' || e.key==='S'){ e.preventDefault(); btnStep.click(); }
      if(e.key==='r' || e.key==='R'){ e.preventDefault(); btnReset.click(); }
    });

    // 初期化
    drawBase(); updateStats();
  </script>
</body>
</html>
